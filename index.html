<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>

<script>
  // --- Initialize Firebase ---
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore(); 
  const auth = firebase.auth();

  // --- Global Variables ---
  const productList = document.getElementById("productList");
  const loginPage = document.getElementById("loginPage");
  const adminPanel = document.getElementById("adminPanel");
  let currentUser = null; 

  // --- Authentication ---
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loginPage.style.display = "none";
      adminPanel.style.display = "block";
    } else {
      currentUser = null;
      loginPage.style.display = "block";
      adminPanel.style.display = "none";
    }
    getProducts();
  });

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("adminUser").value;
    const password = document.getElementById("adminPass").value;
    if (!email || !password) {
        alert("Please enter an email and password.");
        return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
      console.error("Login Error: ", error);
      alert("Login failed: " + error.message);
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    try {
      await auth.signOut();
    } catch (error) {
      console.error("Logout Error: ", error);
      alert("Logout failed. Check console.");
    }
  };

  // --- Product Functions ---
  async function getProducts() {
    productList.innerHTML = "<p>Loading products...</p>";
    
    const snapshot = await db.collection("products").get(); 
    productList.innerHTML = ""; 

    if (snapshot.empty) {
        productList.innerHTML = "<p>No products available right now.</p>";
        return;
    }

    snapshot.forEach(doc => {
      const p = doc.data();
      const id = doc.id;
      const isAdmin = (currentUser != null); 
      
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>${p.price}</p>
        ${isAdmin ? `
          <button onclick="deleteProduct('${id}')">Delete</button>
          <button onclick="editProduct('${id}', '${p.name}', '${p.price}', '${p.img}')">Edit</button>` : ""}
      `;
      productList.appendChild(card);
    });
  }
  
  document.getElementById("addProductBtn").onclick = async () => {
    const name = document.getElementById("newName").value;
    const price = document.getElementById("newPrice").value;
    const img = document.getElementById("newImg").value;
    
    if(name && price && img) {
      try {
        await db.collection("products").add({ name, price, img });
        getProducts(); 
        alert("Product added!");
        document.getElementById("newName").value = "";
        document.getElementById("newPrice").value = "";
        document.getElementById("newImg").value = "";
      } catch (error) {
        console.error("Error adding product: ", error);
        alert("Error: Only logged-in admins can add products.");
      }
    } else { 
      alert("Please fill all fields."); 
    }
  };

  async function deleteProduct(id) {
    if (confirm("Are you sure you want to delete this product?")) {
        try {
            await db.collection("products").doc(id).delete();
            getProducts();
            alert("Product deleted.");
        } catch (error) {
            console.error("Error deleting product: ", error);
            alert("Error: Only logged-in admins can delete products.");
        }
    }
  }

  async function editProduct(id, oldName, oldPrice, oldImg) {
    const name = prompt("Edit product name:", oldName);
    const price = prompt("Edit product price:", oldPrice);
    const img = prompt("Edit product image URL:", oldImg);
    
    if(name && price && img) {
        try {
            await db.collection("products").doc(id).update({ name, price, img });
            getProducts();
        } catch (error) {
            console.error("Error updating product: ", error);
            alert("Error: Only logged-in admins can edit products.");
        }
    }
  }

  // --- Splash Screen & Theme Toggle (Unchanged) ---
  const splash = document.getElementById("splash");
  window.addEventListener("load", () => {
      setTimeout(() => { splash.style.opacity = 0; }, 500);
      setTimeout(() => { splash.style.display = "none"; }, 1500);
  });

  const themeToggle = document.getElementById("themeToggle");
  themeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      themeToggle.innerText = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  };
  
  // -------------------------------------------------
  // --- CHATBOT (NEW UPDATED FUNCTION) ---
  // -------------------------------------------------
  async function sendMessage() {
    const chatInput = document.getElementById("chatInput").value;
    const chatResponse = document.getElementById("chatResponse");

    if (!chatInput) {
      chatResponse.innerHTML = "<p>How can I help you today?</p>";
      return;
    }

    // Convert input to lowercase for easier matching
    const query = chatInput.toLowerCase();
    chatResponse.innerHTML = `<p>Searching for "${chatInput}"...</p>`;

    try {
      // Get all products from Firestore
      const snapshot = await db.collection("products").get();
      let results = [];
      
      // Filter products in JavaScript to find matches
      snapshot.forEach(doc => {
        const p = doc.data();
        // Check if the product name *includes* the query
        if (p.name.toLowerCase().includes(query)) {
          results.push(p);
        }
      });

      // Display the results
      if (results.length > 0) {
        chatResponse.innerHTML = `<p>Found ${results.length} matching product(s):</p>`;
        results.forEach(p => {
            chatResponse.innerHTML += `
              <div style="border: 1px solid #eee; padding: 5px; margin-top: 5px; border-radius: 4px;">
                <strong>${p.name}</strong> - ${p.price}
              </div>
            `;
        });
      } else {
        // Handle a few simple, non-product questions
        if (query.includes("hello") || query.includes("hi")) {
            chatResponse.innerHTML = "<p>Hello! How can I help you with our products today?</p>";
        } else if (query.includes("how are you")) {
            chatResponse.innerHTML = "<p>I'm a bot, but I'm ready to find you some great scents!</p>";
        } else {
            chatResponse.innerHTML = `<p>Sorry, I couldn't find any products matching "${chatInput}".</p>`;
        }
      }

    } catch (error) {
      console.error("Chatbot error: ", error);
      chatResponse.innerHTML = "<p>Sorry, I ran into an error. Please try again.</p>";
    }
  }
</script>
